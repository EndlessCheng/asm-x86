     1                                           ;代码清单13-1
     2                                           ;文件名：c13_mbr.asm
     3                                           ;文件说明：硬盘主引导扇区代码 
     4                                           ;创建日期：2011-10-28 22:35        ;设置堆栈段和栈指针 
     5                                           
     6                                           core_base_address equ 0x00040000   ;常数，内核加载的起始内存地址 
     7                                           core_start_sector equ 0x00000001   ;常数，内核的起始逻辑扇区号 
     8                                           
     9 00000000 8CC8                             mov ax,cs      
    10 00000002 8ED0                             mov ss,ax
    11 00000004 BC007C                           mov sp,0x7c00
    12                                        
    13                                           ;计算GDT所在的逻辑段地址
    14 00000007 2E66A1[A07D]                     mov eax,[cs:pgdt+0x7c00+0x02]      ;GDT的32位物理地址 
    15 0000000C 6631D2                           xor edx,edx
    16 0000000F 66BB10000000                     mov ebx,16
    17 00000015 66F7F3                           div ebx                            ;分解成16位逻辑地址 
    18                                  
    19 00000018 8ED8                             mov ds,eax                         ;令DS指向该段以进行操作
    20 0000001A 6689D3                           mov ebx,edx                        ;段内起始偏移地址 
    21                                  
    22                                           ;跳过0#号描述符的槽位 
    23                                           ;创建1#描述符，这是一个数据段，对应0~4GB的线性地址空间
    24 0000001D 6766C74308FFFF0000               mov dword [ebx+0x08],0x0000ffff    ;基地址为0，段界限为0xFFFFF
    25 00000026 6766C7430C0092CF00               mov dword [ebx+0x0c],0x00cf9200    ;粒度为4KB，存储器段描述符 
    26                                  
    27                                           ;创建保护模式下初始代码段描述符
    28 0000002F 6766C74310FF01007C               mov dword [ebx+0x10],0x7c0001ff    ;基地址为0x00007c00，界限0x1FF 
    29 00000038 6766C7431400984000               mov dword [ebx+0x14],0x00409800    ;粒度为1个字节，代码段描述符 
    30                                  
    31                                           ;建立保护模式下的堆栈段描述符      ;基地址为0x00007C00，界限0xFFFFE 
    32 00000041 6766C74318FEFF007C               mov dword [ebx+0x18],0x7c00fffe    ;粒度为4KB 
    33 0000004A 6766C7431C0096CF00               mov dword [ebx+0x1c],0x00cf9600
    34                                           
    35                                           ;建立保护模式下的显示缓冲区描述符   
    36 00000053 6766C74320FF7F0080               mov dword [ebx+0x20],0x80007fff    ;基地址为0x000B8000，界限0x07FFF 
    37 0000005C 6766C743240B924000               mov dword [ebx+0x24],0x0040920b    ;粒度为字节
    38                                           
    39                                           ;初始化描述符表寄存器GDTR
    40 00000065 2EC706[9E7D]2700                 mov word [cs: pgdt+0x7c00],39      ;描述符表的界限   
    41                                   
    42 0000006C 2E0F0116[9E7D]                   lgdt [cs: pgdt+0x7c00]
    43                                        
    44 00000072 E492                             in al,0x92                         ;南桥芯片内的端口 
    45 00000074 0C02                             or al,0000_0010B
    46 00000076 E692                             out 0x92,al                        ;打开A20
    47                                  
    48 00000078 FA                               cli                                ;中断机制尚未工作
    49                                  
    50 00000079 0F20C0                           mov eax,cr0
    51 0000007C 660D01000000                     or eax,1
    52 00000082 0F22C0                           mov cr0,eax                        ;设置PE位
    53                                        
    54                                           ;以下进入保护模式... ...
    55 00000085 66EA[8D000000]1000               jmp dword 0x0010:flush             ;16位的描述符选择子：32位偏移
    56                                                                              ;清流水线并串行化处理器
    57                                           [bits 32]               
    58                                    flush:                                  
    59 0000008D B808000000                       mov eax,0x0008                     ;加载数据段(0..4GB)选择子
    60 00000092 8ED8                             mov ds,eax
    61                                        
    62 00000094 B818000000                       mov eax,0x0018                     ;加载堆栈段选择子 
    63 00000099 8ED0                             mov ss,eax
    64 0000009B 31E4                             xor esp,esp                        ;堆栈指针 <- 0 
    65                                           
    66                                           ;以下加载系统核心程序 
    67 0000009D BF00000400                       mov edi,core_base_address 
    68                                        
    69 000000A2 B801000000                       mov eax,core_start_sector
    70 000000A7 89FB                             mov ebx,edi                        ;起始地址 
    71 000000A9 E88D000000                       call read_hard_disk_0              ;以下读取程序的起始部分（一个扇区） 
    72                                        
    73                                           ;以下判断整个程序有多大
    74 000000AE 8B07                             mov eax,[edi]                      ;核心程序尺寸
    75 000000B0 31D2                             xor edx,edx 
    76 000000B2 B900020000                       mov ecx,512                        ;512字节每扇区
    77 000000B7 F7F1                             div ecx
    78                                  
    79 000000B9 09D2                             or edx,edx
    80 000000BB 7501                             jnz @1                             ;未除尽，因此结果比实际扇区数少1 
    81 000000BD 48                               dec eax                            ;已经读了一个扇区，扇区总数减1 
    82                                     @1:
    83 000000BE 09C0                             or eax,eax                         ;考虑实际长度≤512个字节的情况 
    84 000000C0 7410                             jz setup                           ;EAX=0 ?
    85                                  
    86                                           ;读取剩余的扇区
    87 000000C2 89C1                             mov ecx,eax                        ;32位模式下的LOOP使用ECX
    88 000000C4 B801000000                       mov eax,core_start_sector
    89 000000C9 40                               inc eax                            ;从下一个逻辑扇区接着读
    90                                     @2:
    91 000000CA E86C000000                       call read_hard_disk_0
    92 000000CF 40                               inc eax
    93 000000D0 E2F8                             loop @2                            ;循环读，直到读完整个内核 
    94                                  
    95                                   setup:
    96 000000D2 8B35[A07D0000]                   mov esi,[0x7c00+pgdt+0x02]         ;不可以在代码段内寻址pgdt，但可以
    97                                                                              ;通过4GB的段来访问
    98                                           ;建立公用例程段描述符
    99 000000D8 8B4704                           mov eax,[edi+0x04]                 ;公用例程代码段起始汇编地址
   100 000000DB 8B5F08                           mov ebx,[edi+0x08]                 ;核心数据段汇编地址
   101 000000DE 29C3                             sub ebx,eax
   102 000000E0 4B                               dec ebx                            ;公用例程段界限 
   103 000000E1 01F8                             add eax,edi                        ;公用例程段基地址
   104 000000E3 B900984000                       mov ecx,0x00409800                 ;字节粒度的代码段描述符
   105 000000E8 E896000000                       call make_gdt_descriptor
   106 000000ED 894628                           mov [esi+0x28],eax
   107 000000F0 89562C                           mov [esi+0x2c],edx
   108                                         
   109                                           ;建立核心数据段描述符
   110 000000F3 8B4708                           mov eax,[edi+0x08]                 ;核心数据段起始汇编地址
   111 000000F6 8B5F0C                           mov ebx,[edi+0x0c]                 ;核心代码段汇编地址 
   112 000000F9 29C3                             sub ebx,eax
   113 000000FB 4B                               dec ebx                            ;核心数据段界限
   114 000000FC 01F8                             add eax,edi                        ;核心数据段基地址
   115 000000FE B900924000                       mov ecx,0x00409200                 ;字节粒度的数据段描述符 
   116 00000103 E87B000000                       call make_gdt_descriptor
   117 00000108 894630                           mov [esi+0x30],eax
   118 0000010B 895634                           mov [esi+0x34],edx 
   119                                        
   120                                           ;建立核心代码段描述符
   121 0000010E 8B470C                           mov eax,[edi+0x0c]                 ;核心代码段起始汇编地址
   122 00000111 8B1F                             mov ebx,[edi+0x00]                 ;程序总长度
   123 00000113 29C3                             sub ebx,eax
   124 00000115 4B                               dec ebx                            ;核心代码段界限
   125 00000116 01F8                             add eax,edi                        ;核心代码段基地址
   126 00000118 B900984000                       mov ecx,0x00409800                 ;字节粒度的代码段描述符
   127 0000011D E861000000                       call make_gdt_descriptor
   128 00000122 894638                           mov [esi+0x38],eax
   129 00000125 89563C                           mov [esi+0x3c],edx
   130                                  
   131 00000128 66C705[9E7D0000]3F-              mov word [0x7c00+pgdt],63          ;描述符表的界限
   132 00000130 00                 
   133                                                                          
   134 00000131 0F0115[9E7D0000]                 lgdt [0x7c00+pgdt]                  
   135                                  
   136 00000138 FF6F10                           jmp far [edi+0x10]  
   137                                         
   138                                  ;-------------------------------------------------------------------------------
   139                                  read_hard_disk_0:                        ;从硬盘读取一个逻辑扇区
   140                                                                           ;EAX=逻辑扇区号
   141                                                                           ;DS:EBX=目标缓冲区地址
   142                                                                           ;返回：EBX=EBX+512 
   143 0000013B 50                               push eax 
   144 0000013C 51                               push ecx
   145 0000013D 52                               push edx
   146                                        
   147 0000013E 50                               push eax
   148                                           
   149 0000013F 66BAF201                         mov dx,0x1f2
   150 00000143 B001                             mov al,1
   151 00000145 EE                               out dx,al                       ;读取的扇区数
   152                                  
   153 00000146 6642                             inc dx                          ;0x1f3
   154 00000148 58                               pop eax
   155 00000149 EE                               out dx,al                       ;LBA地址7~0
   156                                  
   157 0000014A 6642                             inc dx                          ;0x1f4
   158 0000014C B108                             mov cl,8
   159 0000014E D3E8                             shr eax,cl
   160 00000150 EE                               out dx,al                       ;LBA地址15~8
   161                                  
   162 00000151 6642                             inc dx                          ;0x1f5
   163 00000153 D3E8                             shr eax,cl
   164 00000155 EE                               out dx,al                       ;LBA地址23~16
   165                                  
   166 00000156 6642                             inc dx                          ;0x1f6
   167 00000158 D3E8                             shr eax,cl
   168 0000015A 0CE0                             or al,0xe0                      ;第一硬盘  LBA地址27~24
   169 0000015C EE                               out dx,al
   170                                  
   171 0000015D 6642                             inc dx                          ;0x1f7
   172 0000015F B020                             mov al,0x20                     ;读命令
   173 00000161 EE                               out dx,al
   174                                  
   175                                    .waits:
   176 00000162 EC                               in al,dx
   177 00000163 2488                             and al,0x88
   178 00000165 3C08                             cmp al,0x08
   179 00000167 75F9                             jnz .waits                      ;不忙，且硬盘已准备好数据传输 
   180                                  
   181 00000169 B900010000                       mov ecx,256                     ;总共要读取的字数
   182 0000016E 66BAF001                         mov dx,0x1f0
   183                                    .readw:
   184 00000172 66ED                             in ax,dx
   185 00000174 668903                           mov [ebx],ax
   186 00000177 81C302000000                     add ebx,2
   187 0000017D E2F3                             loop .readw
   188                                  
   189 0000017F 5A                               pop edx
   190 00000180 59                               pop ecx
   191 00000181 58                               pop eax
   192                                        
   193 00000182 C3                               ret
   194                                  
   195                                  ;-------------------------------------------------------------------------------
   196                                  make_gdt_descriptor:                     ;构造描述符
   197                                                                           ;输入：EAX=线性基地址
   198                                                                           ;      EBX=段界限
   199                                                                           ;      ECX=属性（各属性位都在原始
   200                                                                           ;      位置，其它没用到的位置0） 
   201                                                                           ;返回：EDX:EAX=完整的描述符
   202 00000183 89C2                             mov edx,eax
   203 00000185 C1E010                           shl eax,16                     
   204 00000188 6609D8                           or ax,bx                        ;描述符前32位(EAX)构造完毕
   205                                        
   206 0000018B 81E20000FFFF                     and edx,0xffff0000              ;清除基地址中无关的位
   207 00000191 C1C208                           rol edx,8
   208 00000194 0FCA                             bswap edx                       ;装配基址的31~24和23~16  (80486+)
   209                                        
   210 00000196 6631DB                           xor bx,bx
   211 00000199 09DA                             or edx,ebx                      ;装配段界限的高4位
   212                                        
   213 0000019B 09CA                             or edx,ecx                      ;装配属性 
   214                                        
   215 0000019D C3                               ret
   216                                        
   217                                  ;-------------------------------------------------------------------------------
   218 0000019E 0000                             pgdt             dw 0
   219 000001A0 007E0000                                          dd 0x00007e00      ;GDT的物理地址
   220                                  ;-------------------------------------------------------------------------------                             
   221 000001A4 00<rept>                         times 510-($-$$) db 0
   222 000001FE 55AA                                              db 0x55,0xaa
